name: Security Scan
on:
  push:
    branches: [main]
  schedule:
    - cron: '0 6 * * 1'  # Monday 6AM UTC
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Install scanners
        run: |
          pip install bandit safety 2>/dev/null || true
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sh -s -- -b /usr/local/bin v0.51.0 2>/dev/null || true

      - name: Bandit (Python security)
        run: bandit -r src/ -ll -f json -o bandit-report.json 2>/dev/null || true

      - name: Safety (dependency vulns)
        run: safety check --json > safety-report.json 2>/dev/null || true

      - name: Trivy filesystem scan
        run: trivy fs --format sarif --output trivy-results.sarif . 2>/dev/null || true

      - name: Secret patterns scan
        run: |
          echo "Scanning for exposed secrets..."
          grep -rn "sk-proj-\|sk-ant-\|hf_\|ghp_\|AKIA" \
            --include="*.py" --include="*.ts" --include="*.js" \
            --exclude-dir=".git" --exclude-dir="node_modules" . 2>/dev/null && \
            echo "SECRETS FOUND - review immediately!" || echo "No secrets found"

      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif
        continue-on-error: true

      - name: Summary
        run: |
          echo "## Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Bandit: $(cat bandit-report.json 2>/dev/null | python3 -c 'import json,sys; d=json.load(sys.stdin); print(len(d.get(\"results\",[])), \"issues\")' 2>/dev/null || echo 'N/A')" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy: scan complete" >> $GITHUB_STEP_SUMMARY

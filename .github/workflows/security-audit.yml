name: Security Audit

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 6 * * 1"  # Every Monday at 06:00 UTC
  workflow_dispatch:

jobs:
  semgrep:
    name: SAST â€” Semgrep
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep
    steps:
      - uses: actions/checkout@v4
      - name: Run Semgrep
        run: |
          semgrep scan --config=auto --error --json > semgrep-results.json 2>/dev/null || true
          semgrep scan --config=auto --severity=ERROR --error 2>&1 | tail -20

  bandit:
    name: SAST â€” Bandit (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Bandit
        run: pip install bandit[toml]
      - name: Run Bandit
        run: |
          find . -name "*.py" -not -path "./.git/*" -not -path "./node_modules/*" | head -100 | \
            xargs bandit -ll -ii --format json -o bandit-results.json || true
          find . -name "*.py" -not -path "./.git/*" | head -100 | \
            xargs bandit -ll -ii 2>&1 | tail -30

  npm-audit:
    name: Dependency Audit â€” npm
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Run npm audit on all package.json
        run: |
          find . -name "package.json" -not -path "./.git/*" -not -path "*/node_modules/*" | while read f; do
            dir=$(dirname "$f")
            echo "=== Auditing $dir ==="
            cd "$dir"
            if [ -f package-lock.json ]; then
              npm audit --audit-level=high || true
            else
              npm install --package-lock-only --ignore-scripts 2>/dev/null && npm audit --audit-level=high || true
            fi
            cd -
          done

  secret-scan:
    name: Secret Detection â€” TruffleHog
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  dependency-scan:
    name: Dependency Scan â€” Safety
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install safety
        run: pip install safety
      - name: Scan dependencies
        run: |
          find . -name "requirements*.txt" -not -path "./.git/*" | while read f; do
            echo "Scanning $f"
            safety check -r "$f" || true
          done

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [semgrep, bandit, npm-audit, secret-scan, dependency-scan]
    if: always()
    steps:
      - name: Report
        run: |
          echo "### ðŸ” Security Audit Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Semgrep SAST | ${{ needs.semgrep.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bandit Python | ${{ needs.bandit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| npm audit | ${{ needs.npm-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TruffleHog | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Safety | ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY

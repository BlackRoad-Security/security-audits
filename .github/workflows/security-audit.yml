name: Security Audit

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 6 * * 1"  # Every Monday at 06:00 UTC

jobs:
  semgrep:
    name: SAST — Semgrep
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep
    steps:
      - uses: actions/checkout@v4
      - name: Run Semgrep
        run: |
          semgrep scan --config=auto --error --json > semgrep-results.json 2>/dev/null || true
          semgrep scan --config=auto --severity=ERROR --error 2>&1 | tail -20

  secret-scan:
    name: Secret Detection — TruffleHog
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  dependency-scan:
    name: Dependency Scan — Safety
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install safety
        run: pip install safety
      - name: Scan dependencies
        run: |
          find . -name "requirements*.txt" | while read f; do
            echo "Scanning $f"
            safety check -r "$f" || true
          done
          find . -name "pyproject.toml" | while read f; do
            echo "Scanning $f"
            safety check || true
          done

